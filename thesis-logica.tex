\chapter{Progettazione logica}

Lo schema concettuale presentato nel Capitolo \ref{conceptual} rappresenta in modo accurato il dominio a livello astratto ma la traduzione in uno schema logico nel modello relazionale richiede la semplificazione di alcune strutture concettuali.
In seguito a questo passaggio di ristrutturazione si definisce uno schema logico, costituito da un insieme di relazioni con eventuali vincoli posti su di esse.

\section{Ristrutturazione dello schema Entità-Relazione}

Il formalismo del modello Entità-Relazione permette di utilizzare strutture piuttosto complesse a livello concettuale, come ad esempio le relazioni di specializzazione o gli attributi multivalore.
Per facilitare la traduzione in uno schema logico nel modello relazionale è necessario operare una ristrutturazione o semplificazione dello schema iniziale \cite{Atz23}, con l'obiettivo di ottenere soltanto entità senza specializzazioni o categorie, attributi semplici e relazioni binarie.
Nella fase di ristrutturazione si valuta se è opportuno mantenere gli attributi ridondanti per motivi di efficienza e si scelgono gli attributi chiave delle entità che hanno più candidati possibili.

Lo schema ristrutturato, mostrato in Figura \ref{completererdiagram}, rimane espresso nel modello Entità-Relazione, ma non si può più considerare puramente concettuale perché introduce modifiche dettate non dalle caratteristiche del dominio ma da aspetti implementativi e ottimizzazione delle prestazioni.
Dopo la ristrutturazione, la traduzione può essere fatta in modo meccanico perché i costrutti più elementari del modello Entità-Relazione hanno dei corrispettivi diretti nel modello relazionale.

\subsection{Ristrutturazione dell'area concettuale della gravidanza}

La Figura \ref{pregnancyrerdiagram} mostra l'ingrandimento dello schema Entità-Relazione ristrutturato per quanto riguarda le entità Paziente, Gravidanza e Malattia.
Di queste solo Gravidanza subisce delle modifiche rispetto allo schema concettuale.

\subsubsection{Gravidanza}

Nell'entità Gravidanza semplifichiamo gli attributi composti in attributi semplici, legandoli quindi direttamente alla gravidanza.
Si rimuove la \enquote{rappresentazione testuale}, presente nello schema concettuale come attributo derivato e direttamente calcolabile a partire dagli altri componenti dell'attributo composto Parità.
Viene mantenuto il vincolo posto sulla non decrescenza o crescenza stretta dei componenti dell'attributo Parità.

Gravidanza è entità debole ed è identificata dalla relazione con Paziente.
Tra le due chiavi parziali possibili si sceglie l'attributo Data primo ingresso perché è costituito da un solo attributo invece che da quattro diversi, risultando quindi molto più semplice da utilizzare come identificatore della gravidanza nelle diverse relazioni in cui questa entità partecipa.
La quadrupla di attributi risultante dalla decomposizione di Parità, in quanto chiave candidata nel modello concettuale, mantiene le proprietà di chiave e quindi si pone un ulteriore vincolo di unicità\footnote{
    Il vincolo di non avere valore \emph{NULL} è già espresso dall'assenza dell'indicazione (0,1) su tutti gli attributi, quindi nessuno di essi è opzionale.
}.
\begin{quote}
La quadrupla di attributi che compongono la parità deve essere unica per ogni paziente.
\end{quote}

\subsection{Ristrutturazione dell'area concettuale delle visite}

La Figura \ref{visitsrerdiagram} mostra l'ingrandimento dello schema Entità-Relazione ristrutturato per quanto riguarda le entità relative alle visite e all'entità Esame.
Quest'ultima non subisce modifiche nella ristrutturazione.

\subsubsection{Visite}

Considerando la presenza di molti attributi in comune, le diverse entità coinvolte nella categoria Visita collassano in un'unica entità.
Si introduce quindi un attributo ulteriore che indica a quale delle quattro classi di visite appartiene ogni istanza dell'entità Visita.

L'entità Visita rimane debole rispetto a Gravidanza, come erano tutte le diverse visite presenti nello schema concettuale, introducendo come chiave parziale la data per tutte.
L'attributo \enquote{Anomalie morfologiche fetali} della visita del primo trimestre e l'equivalente \enquote{Anomalie fetali} della visita del secondo trimestre confluiscono in un unico attributo.
L'attributo BMI, calcolabile facilmente a partire da peso e altezza, è ridondante e si può rimuovere.

Come conseguenza della semplificazione della categoria, la relazione che Visita ha con Esame modifica la partecipazione rendendola parziale, dato che non è richiesto che ad ogni visita vengano effettuati esami.
Le diverse relazioni che legavano le entità originali a Gravidanza si riducono a una sola relazione sulla quale si pongono nuovi vincoli per rispettare la cardinalità imposta dalle relazioni originali.
\begin{quote}
Ogni gravidanza può effettuare al massimo una sola visita del primo trimestre. \\
Ogni gravidanza può effettuare al massimo una sola visita del secondo trimestre.
\end{quote}

\subsection{Ristrutturazione dell'area concettuale del parto}

La Figura \ref{deliveryrerdiagram} mostra l'ingrandimento dello schema Entità-Relazione ristrutturato per quanto riguarda le entità parto, con le sue specializzazioni, e Travaglio.
Entrambe subiscono modifiche rispetto allo schema originale.

\subsubsection{Parto}

Considerando il fatto che la complessa gerarchia di specializzazioni dell'entità Parto è totale e sovrapposta, scegliamo di ristrutturarla ottenendo un'unica entità Parto a cui si aggiungono tutti gli attributi delle entità figlie più un attributo \enquote{Tipo di parto} per differenziare il tipo effettivo\footnote{
    Considerando le sovrapposizioni possibili esposte nella Sezione \ref{deliveryconceptual}, i valori del dominio dell'attributo Tipo di parto sono: naturale, operativo, cesareo programmato, cesareo urgente, naturale e operativo, naturale e cesareo urgente, operativo e cesareo urgente.
}.
Gli attributi composti come Tempi e Secondamento vengono scomposti e si legano direttamente a Parto; quelli che prima erano obbligatori per le entità figlie diventano opzionali nell'entità Parto ristrutturata.

\subsubsection{Travaglio e induzione}

L'attributo composto e multivalore Induzione diventa un'entità a sé stante, con il tempo di somministrazione come chiave parziale.
L'entità Travaglio rimane senza nessun attributo, quindi la rimuoviamo per legare direttamente Parto e Induzione; l'entità Induzione diventa quindi debole rispetto a Parto.

\subsection{Ristrutturazione dell'area concettuale del neonato}

La Figura \ref{newbornrerdiagram} mostra l'ingrandimento dello schema Entità-Relazione ristrutturato per quanto riguarda le entità Neonato, Tracciato CTG e Misurazione CTG.
Le differenze rispetto allo schema originale sono minime: nell'entità Neonato l'attributo composto APGAR viene diviso nelle sue componenti che vengono collegate direttamente a Neonato, mentre nell'entità Tracciato CTG si sceglie come chiave la relazione identificante con l'entità Parto.

\begin{figure}
    \centering
    \includesvg{vectors/modello-er-ristrutturato.svg}
    \caption{Schema Entità-Relazione ristrutturato. Visione d'insieme semplificata, contenente soltanto entità e relazioni del modello. Le aree tratteggiate delimitano gli stessi ingrandimenti dello schema concettuale originale.}
    \label{completererdiagram}
\end{figure}

\begin{figure}
    \centering
    \includesvg{vectors/modello-er-ristrutturato-gravidanza.svg}
    \caption{Schema Entità-Relazione ristrutturato. Ingrandimento dell'area gravidanza.}
\label{pregnancyrerdiagram}
\end{figure}

\begin{figure}
    \centering
    \includesvg{vectors/modello-er-ristrutturato-visite.svg}
    \caption{Schema Entità-Relazione ristrutturato. Ingrandimento dell'area visite.}
\label{visitsrerdiagram}
\end{figure}

\begin{figure}
    \centering
    \includesvg{vectors/modello-er-ristrutturato-parto.svg}
    \caption{Schema Entità-Relazione ristrutturato. Ingrandimento dell'area parto.}
\label{deliveryrerdiagram}
\end{figure}

\begin{figure}
    \centering
    \includesvg{vectors/modello-er-ristrutturato-neonato.svg}
    \caption{Schema Entità-Relazione ristrutturato. Ingrandimento dell'area neonato.}
\label{newbornrerdiagram}
\end{figure}

\newpage

\section{Schema logico relazionale}
